syntax = "proto3";

package google.internal.cloud.sqlagent.v1;

import "google/api/annotations.proto";
import "google/api/policy.proto";
import "google/internal/cloud/sqlagent/v1/agent_operation.proto";
import "google/protobuf/any.proto";
import "logs/eventid/eventid.proto";
import "storage/datapol/annotations/proto/semantic_annotations.proto";
import "storage/speckle/proto/experiment_data.proto";
import "util/task/status.proto";

option java_multiple_files = true;
option java_outer_classname = "PollServiceProto";
option java_package = "com.google.internal.cloud.sqlagent.v1";

service SqlAgentService {
    rpc Poll(PollRequest) returns (AgentTaskProto);
    rpc ExperimentPoll(ExperimentPollRequest) returns (ExperimentPollResponse);
    rpc StorageResize(StorageResizeRequest) returns (StorageResizeResponse);
    rpc UpdateFailoverReplicaState(UpdateFailoverReplicaStateRequest) returns (UpdateFailoverReplicaStateResponse);
    rpc DelegateCreateIAMGroupFirstTimeUser(DelegateCreateIAMGroupFirstTimeUserRequest) returns (DelegateCreateIAMGroupFirstTimeUserResponse);
    rpc LogEvent(LogEventRequest) returns (LogEventResponse);
    rpc SnapshotInstance(SnapshotInstanceRequest) returns (SnapshotInstanceResponse);
}

message PollRequest {
    string instance_name = 1;
    OperationResponse operation_response = 3;
    string vm_name = 4;
    bool operation_in_progress = 5;
    string instance_uid = 6;
    
    reserved 2;
}

message AgentTaskProto {
    string instance_name = 2 [deprecated = true];
    OperationRequest operation_request = 3;
    AgentType agent_type = 4;
    string image = 5;
    int64 seq_id = 6;
    string sync_operation_id = 7;
    string sync_operation_response_topic_project_id = 8;
    string sync_operation_response_topic = 9;
    string instance_uid = 10;
    int64 timeout_millis = 11;
    EventIdMessage event_id = 12;
    
    oneof target {
        AgentServiceTarget agent_service_target = 21;
        PubsubTarget pubsub_target = 22;
    }
    
    oneof _use_vm_check {
        bool use_vm_check = 13;
    }
    
    reserved 1;
}

message AgentServiceTarget {
    string vm_name = 1;
    string regional_vm_name = 2;
}

message PubsubTarget {
    string topic = 1;
}

message StorageResizeRequest {
    string vm_name = 1;
    string instance_name = 2;
    DiskStat disk_stat = 3;
    string instance_uid = 4;
    DiskKind disk = 5;
}

message DiskStat {
    int64 block_size_gb = 1;
    int64 total_bytes = 2;
    int64 available_bytes = 3;
    int64 increase_size_gb = 4;
    int64 billed_size_gb = 5;
}

message StorageResizeResponse {
    
}

message UpdateFailoverReplicaStateRequest {
    string instance_name = 1;
    FailoverReplicaState failover_replica_state = 2;
    string vm_name = 3;
    string instance_uid = 4;
}

message FailoverReplicaState {
    bool failover_replica_available = 1;
}

message UpdateFailoverReplicaStateResponse {
    util.StatusProto status = 1;
}

message ExperimentPollRequest {
    string instance_name = 1;
    string instance_uid = 2;
    string vm_name = 3;
    int64 experiment_snapshot_id = 4;
}

message ExperimentPollData {
    repeated .speckle.ExperimentData data = 1;
    int64 experiment_snapshot_id = 2;
    repeated int32 id = 3 [packed = true];
}

message ExperimentPollResponse {
    ExperimentPollData experiments = 1;
    bool same_experiment_snapshot = 2;
}

message DelegateCreateIAMGroupFirstTimeUserRequest {
    string instance_name = 1;
    string instance_uid = 2;
    string vm_name = 3;
    string username = 4;
    string hostname = 5;
    repeated string membership_groups = 6;
    UserType usertype = 7;
    string access_token = 8;
}

message DelegateCreateIAMGroupFirstTimeUserResponse {
    
}

message LogEventRequest {
    string instance_name = 1;
    string instance_uid = 5;
    string vm_name = 6;
    string log_source = 2;
    string log_type = 3;
    protobuf.Any log_message = 4;
}

message LogEventResponse {
    
}

message SnapshotInstanceRequest {
    string instance_name = 1;
    string instance_uid = 2;
    string vm_name = 3;
}

message SnapshotInstanceResponse {
    util.StatusProto status = 1;
    bool retryable = 2;
}

enum DiskKind {
    UNKNOWN_DISK_KIND = 0;
    BOOT_DISK = 1;
    DATA_DISK = 2;
    EPHEMERAL_DISK = 3;
    NON_CRITICAL_DISK = 4;
    BINLOG_DISK = 5;
    REDOLOG_DISK = 6;
}

enum UserType {
    USER_TYPE_UNSPECIFIED = 0;
    CLOUD_IAM_GROUP_USER = 1;
    CLOUD_IAM_GROUP_SERVICE_ACCOUNT = 2;
}
