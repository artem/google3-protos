syntax = "editions";

package speckle_dogfish.dogfish_proto;

import "google/protobuf/timestamp.proto";
import "storage/datapol/annotations/proto/semantic_annotations.proto";
import "storage/speckle/dogfish/proto/dogfish.proto";

message ShardConfiguration {
    repeated int32 replica_ids = 1;
}

message ShardConfigurationState {
    optional int32 shard_id = 8;
    optional int64 version = 1;
    optional ShardConfiguration current = 2;
    optional ShardConfiguration target = 3;
    optional uint64 global_repd_trim_lsn = 4;
    optional ChecksummedLsn global_repd_trim_checksummed_lsn = 7;
    
    optional GlobalRePDTrimChecksummedLsnSource global_repd_trim_checksummed_lsn_source = 9;
    enum GlobalRePDTrimChecksummedLsnSource {
        SOURCE_UNSPECIFIED = 0;
        BACKFILL_GRTL_SHARD_CONFIG_DOGTOOL = 1;
        EXPERIMENT_ENABLED_INSTANCE = 2;
    }
    
    optional ShardReconfigurationProtocol target_reconfiguration_protocol_version = 5;
    enum ShardReconfigurationProtocol {
        PROTOCOL_UNSPECIFIED = 0;
        MULTI_AGENT_FINALIZE = 1;
        MULTI_AGENT_FINALIZE_V3 = 2;
    }
    
    optional google.protobuf.Timestamp target_proposed_at_timestamp = 6;
    optional ReconfigurationV3Metadata reconfiguration_v3_metadata = 10;
}

message ReconfigurationV3Metadata {
    optional int32 replica_to_add = 1;
    repeated int32 proposed_target_set = 2;
    optional ShardConfiguration proposed_target = 5;
    
    optional ReconfigurationV3State state = 3;
    enum ReconfigurationV3State {
        RECONFIG_V3_STATE_UNSPECIFIED = 0;
        RECONFIG_V3_STATE_PRE_ADD_PHASE = 1;
        RECONFIG_V3_STATE_ADD_PHASE = 2;
        RECONFIG_V3_STATE_PRE_REMOVE_PHASE = 3;
        RECONFIG_V3_STATE_PRE_REMOVE_RO_DRAINING_PHASE = 7;
        RECONFIG_V3_STATE_PRE_REMOVE_START_RO_DRAINING_PHASE = 9;
        RECONFIG_V3_STATE_PRE_REMOVE_APPLY_RO_DRAINING_PHASE = 10;
        RECONFIG_V3_STATE_PRE_REMOVE_START_RO_PHASE = 11;
        RECONFIG_V3_STATE_PRE_REMOVE_APPLY_RO_PHASE = 12;
        RECONFIG_V3_STATE_PRE_REMOVE_RO_PHASE = 8;
        RECONFIG_V3_STATE_REMOVE_PHASE = 4;
        RECONFIG_V3_STATE_START_REMOVE_PHASE = 13;
        RECONFIG_V3_STATE_APPLY_REMOVE_PHASE = 14;
        RECONFIG_V3_STATE_ROLLBACK_START_RO_PHASE = 5;
        RECONFIG_V3_STATE_ROLLBACK_APPLY_WRITABLE_PHASE = 6;
        RECONFIG_V3_STATE_ROLLBACK_APPLY_RO_PHASE = 15;
        RECONFIG_V3_STATE_ROLLBACK_START_REMOVE_PHASE = 16;
        RECONFIG_V3_STATE_ROLLBACK_APPLY_REMOVE_PHASE = 17;
    }
    
    optional int64 expected_configuration_version = 4;
    optional int64 expected_replica_read_only_version = 6;
    optional int64 min_target_quorum_lsn = 7;
    optional string read_only_manager_lro_token = 8;
}
