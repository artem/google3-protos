syntax = "editions";

package speckle_dogfish.dogfish_proto;

import "google/api/policy.proto";
import "google/protobuf/timestamp.proto";
import "logs/proto/dogfish/build-info.proto";
import "storage/datapol/annotations/proto/semantic_annotations.proto";
import "storage/speckle/dogfish/controlplane/proto/storage.proto";
import "storage/speckle/dogfish/proto/data-protection.proto";
import "storage/speckle/dogfish/proto/database-type.proto";
import "storage/speckle/dogfish/proto/dogfish.proto";
import "storage/speckle/dogfish/proto/shard-configuration.proto";

service ShardNameService {
    rpc GetLpsDirectPathAddress(GetLpsDirectPathAddressRequest) returns (GetLpsDirectPathAddressResponse);
    rpc GetLpsBorgInternalAddress(GetLpsBorgInternalAddressRequest) returns (GetLpsBorgInternalAddressResponse);
    rpc GetLpsTaskDebugInfo(GetLpsTaskDebugInfoRequest) returns (GetLpsTaskDebugInfoResponse);
    rpc GetSnsProperties(GetSnsPropertiesRequest) returns (GetSnsPropertiesResponse);
    rpc GetShardReplicaInfo(GetShardReplicaInfoRequest) returns (GetShardReplicaInfoResponse);
    rpc GetVolumeShardInfo(GetVolumeShardInfoRequest) returns (GetVolumeShardInfoResponse);
    rpc FinalizeShardReconfiguration(FinalizeShardReconfigurationRequest) returns (FinalizeShardReconfigurationResponse);
    rpc AdvanceShardConfiguration(AdvanceShardConfigurationRequest) returns (AdvanceShardConfigurationResponse);
    rpc UpdateVolumeGarbageCollectionInfo(UpdateVolumeGarbageCollectionInfoRequest) returns (UpdateVolumeGarbageCollectionInfoResponse);
    rpc GetVolumeDatabaseType(GetVolumeDatabaseTypeRequest) returns (GetVolumeDatabaseTypeResponse);
    rpc UpdateVolumeDatabaseType(UpdateVolumeDatabaseTypeRequest) returns (UpdateVolumeDatabaseTypeResponse);
    rpc GetVolumeSize(GetVolumeSizeRequest) returns (GetVolumeSizeResponse);
    rpc RegisterLpsPingCounts(RegisterLpsPingCountsRequest) returns (RegisterLpsPingCountsResponse);
}

message SandboxOverrides {
    optional string sns_forwarding_address = 1;
}

message GetLpsDirectPathAddressRequest {
    optional string volume_name = 2;
    optional int32 shard_id = 3;
    optional int32 replica_id = 4;
    optional BuildInfo client_build_info = 5;
    optional SandboxOverrides sandbox_overrides = 6;
}

message GetLpsDirectPathAddressResponse {
    optional bytes ipv6 = 1;
    optional int32 port = 2;
    optional string bns = 3;
    optional uint64 borg_task_uid = 4;
}

message GetLpsBorgInternalAddressRequest {
    optional string volume_name = 2;
    optional int32 shard_id = 3;
    optional int32 replica_id = 4;
    optional BuildInfo client_build_info = 5;
    optional SandboxOverrides sandbox_overrides = 6;
}

message GetLpsBorgInternalAddressResponse {
    optional bytes ip_addr = 1;
    optional int32 port = 2;
    optional string debug_bns = 3;
    optional uint64 borg_task_uid = 4;
}

message ShardKey {
    optional string volume_name = 1;
    optional int32 shard_id = 2;
    optional int32 replica_id = 3;
}

message EndpointAddress {
    optional bytes ip_addr = 1;
    optional int32 port = 2;
}

message LpsTaskInfo {
    optional EndpointAddress borg_internal_address = 2;
    optional EndpointAddress direct_path_address = 3;
    optional string bns_name = 4;
    optional string hostname = 5;
}

message ShardInfo {
    optional ShardKey shard = 1;
    optional LpsTaskInfo task_info = 2;
}

message GetLpsTaskDebugInfoRequest {
    repeated ShardKey shards = 1;
    optional string volume_name = 2;
    optional BuildInfo client_build_info = 3;
    optional SandboxOverrides sandbox_overrides = 4;
}

message GetLpsTaskDebugInfoResponse {
    repeated ShardInfo shard_infos = 1;
}

message LPSZoneJobMap {
    optional string zone = 1;
    optional string lps_bns = 2;
}

message GetSnsPropertiesRequest {
    optional BuildInfo build_info = 1;
    optional SandboxOverrides sandbox_overrides = 2;
}

message GetSnsPropertiesResponse {
    optional string sns_hostname = 2;
    optional string sns_bns = 3;
    repeated LPSZoneJobMap lps_zone_map = 4;
}

message ShardReplicaInfo {
    optional int32 replica_id = 1;
    optional string zone = 5;
    optional bytes ipv6 = 2;
    optional int32 direct_path_port = 3;
    optional string debug_bns = 4;
}

message GetShardReplicaInfoRequest {
    optional string volume_name = 1;
    optional int32 shard_id = 2;
    optional bool include_direct_path_address = 3;
    optional BuildInfo client_build_info = 4;
    optional SandboxOverrides sandbox_overrides = 5;
}

message GetShardReplicaInfoResponse {
    repeated ShardReplicaInfo replica_infos = 1;
    optional ShardConfigurationState configuration_state = 2;
}

message VolumeShardInfo {
    optional int32 shard_id = 1;
    repeated ShardReplicaInfo replica_infos = 2;
    optional ShardConfigurationState configuration_state = 3;
}

message GetVolumeShardInfoRequest {
    optional string volume_name = 1;
    optional bool include_direct_path_address = 2;
    optional BuildInfo client_build_info = 3;
    optional SandboxOverrides sandbox_overrides = 4;
}

message GetVolumeShardInfoResponse {
    repeated VolumeShardInfo shard_infos = 2;
    optional dcp.storage.VolumeSettings volume_settings = 3;
    optional bool readonly = 4;
    
    reserved 1;
}

message ReplicaSetInfo {
    repeated int32 replica_ids = 1;
    optional uint64 quorum_lsn = 2;
    optional ChecksummedLsn quorum_checksummed_lsn = 3;
    optional int32 shard_id = 4;
}

message AdvanceShardConfigurationRequest {
    optional string volume_name = 1;
    optional int32 shard_id = 2;
    repeated ReplicaSetInfo replica_set_infos = 3;
    optional bool emergency_skip_reconfiguration_finalization_delay = 5;
    optional ShardConfigurationState.GlobalRePDTrimChecksummedLsnSource quorum_checksummed_lsn_source = 7;
    optional BuildInfo client_build_info = 4;
    optional SandboxOverrides sandbox_overrides = 6;
}

message AdvanceShardConfigurationResponse {
    optional ShardConfigurationState configuration_state = 3;
    repeated ShardConfigurationState configuration_states = 4;
}

message FinalizeShardReconfigurationRequest {
    optional string volume_name = 1;
    optional int32 shard_id = 2;
    optional ShardConfigurationState configuration_state = 3;
    optional BuildInfo client_build_info = 4;
    optional SandboxOverrides sandbox_overrides = 5;
}

message FinalizeShardReconfigurationResponse {
    optional ShardConfigurationState configuration_state = 1;
}

message UpdateVolumeGarbageCollectionInfoRequest {
    optional string volume_name = 1;
    optional int64 input_buffer_trim_lsn = 2 [deprecated = true];
    optional int64 low_watermark_lsn = 3;
    optional int64 process_lsn = 4;
    optional int64 checkpoint_lsn = 7;
    optional BuildInfo client_build_info = 5;
    optional ShardInputBufferTrimLsns shard_input_buffer_trim_lsns = 6;
    optional SandboxOverrides sandbox_overrides = 8;
}

message UpdateVolumeGarbageCollectionInfoResponse {
    
}

message GetVolumeDatabaseTypeRequest {
    optional string volume_name = 1;
    optional BuildInfo client_build_info = 2;
    optional SandboxOverrides sandbox_overrides = 3;
}

message GetVolumeDatabaseTypeResponse {
    optional DatabaseType database_type = 1;
}

message UpdateVolumeDatabaseTypeRequest {
    optional string volume_name = 1;
    optional DatabaseType database_type = 2;
    optional BuildInfo client_build_info = 3;
    optional SandboxOverrides sandbox_overrides = 4;
}

message UpdateVolumeDatabaseTypeResponse {
    
}

message GetVolumeSizeRequest {
    optional string volume_name = 1;
    optional SandboxOverrides sandbox_overrides = 2;
}

message GetVolumeSizeResponse {
    optional int64 bytes = 1;
}

message PingCounts {
    optional string bns = 1;
    optional uint64 task_uid = 2;
    optional int32 ping_count = 3;
}

message PingCountsPerLpsPerTimeBucket {
    optional google.protobuf.Timestamp time_bucket_start = 1;
    optional google.protobuf.Timestamp time_bucket_end = 2;
    repeated PingCounts ping_counts = 3;
}

message RegisterLpsPingCountsRequest {
    repeated PingCountsPerLpsPerTimeBucket ping_counts_per_lps = 1;
    optional string ping_source_id = 2;
    optional SandboxOverrides sandbox_overrides = 3;
}

message RegisterLpsPingCountsResponse {
    
}
