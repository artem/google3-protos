syntax = "editions";

package security.data_access;

import "google/protobuf/any.proto";
import "google/protobuf/duration.proto";
import "logs/proto/data_access/access_phase.proto";
import "logs/proto/data_access/admin_access_control_authorization_info.proto";
import "logs/proto/data_access/data_access_log.proto";
import "logs/proto/data_access/method_type.proto";
import "logs/proto/data_access/tenant.proto";
import "net/proto2/proto/descriptor.proto";
import "privacy/data_governance/attributes/proto/annotations.proto";
import "security/authorization/approvals/proto/request_authorization.proto";
import "security/authorization/dynamic/proto/dynamic_access_customizer.proto";
import "security/authorization/iam/proto/approver.proto";
import "security/authorization/reqrat/testing/proto/acl_db.proto";
import "security/context/proto/context.proto";
import "security/credentials/proto/end_user_credentials.proto";
import "security/credentials/proto/principal.proto";
import "security/data_access/controller/public/administration_configuration.proto";
import "security/data_access/controller/public/cloud_context.proto";
import "security/data_access/controller/public/data_access_controller_resources.proto";
import "security/data_access/controller/public/resource_identification_configuration.proto";
import "security/data_access/controller/public/target_info.proto";
import "util/task/status.proto";

option java_multiple_files = true;
option java_package = "com.google.security.data_access.controller.client";

service DataAccessController {
    rpc CacheClientDescriptors(CacheClientDescriptorsRequest) returns (CacheClientDescriptorsResponse);
    rpc CreateHandle(CreateHandleRequest) returns (CreateHandleResponse);
    rpc InitiateDataAccess(InitiateDataAccessRequest) returns (InitiateDataAccessResponse);
    rpc LogDataAccess(LogDataAccessRequest) returns (LogDataAccessResponse);
    rpc FillAndWritePreliminaryLog(FillAndWritePreliminaryLogRequest) returns (FillAndWritePreliminaryLogResponse);
    rpc FillPreliminaryLog(FillPreliminaryLogRequest) returns (FillPreliminaryLogResponse);
    rpc FillAndWriteFinalLog(FillAndWriteFinalLogRequest) returns (FillAndWriteFinalLogResponse);
    rpc LowDependencyMpa(LowDependencyMpaRequest) returns (LowDependencyMpaResponse);
    rpc ExtractTargetInfo(ExtractTargetInfoRequest) returns (ExtractTargetInfoResponse);
}

message FullResponseEncryptionConfigProto {
    optional int32 keystore_config_id = 1;
    optional string master_key_name = 2;
    optional credentials.PrincipalProto decrypt_principal = 3;
}

message CacheClientDescriptorsRequest {
    optional .proto2.FileDescriptorSet descriptors = 1;
}

message CacheClientDescriptorsResponse {
    
}

message CreateHandleRequest {
    optional Environment environment = 1;
    enum Environment {
        ENVIRONMENT_UNSPECIFIED = 0;
        PROD = 1;
        DEV = 2;
    }
    
    optional string gin_server_address = 2;
    optional google.protobuf.Duration gin_readiness_timeout = 7;
    optional string keystore_address = 3;
    optional FullResponseEncryptionConfigProto encryption = 4;
    optional admin.AdministrationConfiguration admin_config = 5;
    optional ResourceIdentificationConfig resource_identification = 6;
    optional bool use_silva = 8;
    
    optional InitStrategy init_strategy = 9;
    enum InitStrategy {
        INIT_STRATEGY_UNSPECIFIED = 0;
        INIT_STRATEGY_LAZY_WHEN_UDP_DISALLOWED = 1;
        INIT_STRATEGY_BLOCKING = 2;
        INIT_STRATEGY_LAZY = 3;
    }
}

message CreateHandleResponse {
    optional int32 handle = 1;
}

message DataAccessContext {
    optional string action = 1;
    optional MethodType method_type = 17;
    optional AccessPhase access_phase = 18;
    optional credentials.EndUserCredentialsProto end_user_creds = 2;
    optional credentials.EndUserCredentialsProto admin_metadata = 16;
    optional string end_user_device_cert = 15;
    optional google.protobuf.Any cloud_check_policy_request = 3;
    optional google.protobuf.Any token_info = 4;
    optional PackagedProto request_proto = 6;
    optional HttpPackagedProto http_packaged_proto = 12;
    optional ControllerAuditing audit_config = 8;
    optional TargetInfo target_info = 7;
    optional privacy.data_governance.attributes.Annotations data_governance_annotations = 9;
    optional int32 unique_id = 10;
    optional credentials.UserPrincipalProto impersonated_user = 11;
    optional CloudPlatform cloud_platform = 13;
    optional string api_service_name = 14;
    optional TenantId tenant_id = 19;
    
    reserved 5;
}

message InitiateDataAccessRequest {
    optional int32 handle = 1;
    optional DataAccessContext request_context = 2;
    optional admin.AdministrativeAccessControl control = 3;
    optional bool skip_client_justification_check = 4;
    optional DataAccessLogProto partial_auth_check_access_log = 6;
}

message InitiateDataAccessResponse {
    optional util.StatusProto status = 1;
    optional AdminAccessControlAuthorizationInfo admin_access_control_authorization_info = 2;
    optional DataAccessLogProto auth_check_access_log = 3;
    
    optional FcglOutcome fcgl_outcome = 4;
    enum FcglOutcome {
        FCGL_OUTCOME_UNSPECIFIED = 0;
        FCGL_OUTCOME_NOT_ATTEMPTED = 1;
        FCGL_OUTCOME_FAILED = 2;
        FCGL_OUTCOME_COMPLETED = 3;
        FCGL_OUTCOME_NEEDED = 4;
    }
}

message FillPreliminaryLogRequest {
    optional int32 handle = 1;
    optional DataAccessLogProto pre_access_log = 2;
    optional PackagedProto request_proto = 3;
    optional HttpPackagedProto http_packaged_proto = 5;
    optional ControllerAuditing audit_config = 4;
}

message FillPreliminaryLogResponse {
    optional DataAccessLogProto pre_access_log = 1;
}

message FillAndWritePreliminaryLogRequest {
    optional FillPreliminaryLogRequest fill_request = 1;
}

message FillAndWritePreliminaryLogResponse {
    optional FillPreliminaryLogResponse fill_response = 1;
    optional util.StatusProto fail_closed_status = 2;
}

message FillAndWriteFinalLogRequest {
    optional int32 handle = 1;
    optional DataAccessLogProto log_entry = 2;
    optional PackagedProto response_proto = 3;
    optional util.StatusProto response_status = 4;
    optional ControllerAuditing audit_config = 5;
}

message FillAndWriteFinalLogResponse {
    
}

message LowDependencyMpaRequest {
    optional security_approvals.RequestDescription request_description = 2;
    optional security_approvals.ServiceDescription service_description = 3;
    repeated string desired_approvals = 4;
    optional credentials.ApprovalStore store = 6;
    optional authorization.dynamic.proto.DynamicAccessCustomizerProto dynamic_access_customizer = 7;
    optional context.LoggableSecurityContextProto security_context = 8;
    optional credentials.EndUserCredentialsProto euc = 9;
    optional authorization.reqrat.testing.proto.DB acl_db = 10;
    optional string thinmint_verifier_key_path = 11;
    
    reserved 1, 5;
}

message LowDependencyMpaResponse {
    optional security_iam.ApproverResponse approver_response = 5;
}

message LogDataAccessRequest {
    optional int32 handle = 1;
    optional DataAccessLogProto log_entry = 2;
    optional google.protobuf.Any unencrypted_response = 3;
}

message LogDataAccessResponse {
    
}

message ExtractTargetInfoRequest {
    optional PackagedProto request_proto = 1;
    optional ControllerAuditing audit_config = 2;
}

message ExtractTargetInfoResponse {
    optional TargetInfo target_info = 1;
}
