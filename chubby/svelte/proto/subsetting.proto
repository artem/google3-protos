syntax = "editions";

package chubby;

import "storage/datapol/annotations/proto/semantic_annotations.proto";

option java_multiple_files = true;
option java_package = "com.google.chubby.svelte.protocol";

message UserNameFilter {
    repeated string user_names = 1;
}

message UserRatioFilter {
    optional double user_ratio = 1;
}

message SubsettingConfigFilter {
    repeated string server_regexes = 3;
    repeated string borg_cell_filter = 4;
    
    oneof user_filter {
        UserNameFilter user_name_filter = 1;
        UserRatioFilter user_ratio_filter = 2;
    }
}

message InitialSubsettingConfig {
    optional SubsettingConfigFilter filter = 1;
    
    oneof behavior {
        int32 subset_size = 2;
        bool no_subsetting = 3;
    }
}

message InitialSubsettingConfigSet {
    repeated InitialSubsettingConfig subsetting_configs = 1;
}

message ShuffleShardingConfigFilter {
    oneof user_filter {
        UserNameFilter user_name_filter = 1;
        UserRatioFilter user_ratio_filter = 2;
    }
}

message ShuffleShardingConfig {
    optional ShuffleShardingConfigFilter filter = 1;
    
    oneof behavior {
        int32 shard_size = 2;
        bool no_sharding = 3;
    }
}

message ShuffleShardingConfigSet {
    repeated ShuffleShardingConfig shuffle_sharding_configs = 1;
}

message ShuffleShardingClientInfo {
    optional int32 consecutive_redirect_count = 1;
}

message ShuffleShard {
    repeated int32 ids = 1;
}

message ShuffleShardingResult {
    optional Status status = 1;
    enum Status {
        UNKNOWN = 0;
        ACCEPTED = 1;
        REDIRECTED = 2;
    }
    
    optional ShardingBehavior sharding_behavior = 2;
    enum ShardingBehavior {
        BEHAVIOR_UNSPECIFIED = 0;
        BEHAVIOR_SHARDED = 1;
        BEHAVIOR_CLEAR_SHARD = 2;
    }
    
    optional ShuffleShard shuffle_shard = 3;
}
