syntax = "editions";

package tcmalloc.tcmalloc_internal.perftools.profiles;

message HistogramEntry {
    optional int64 lower_bound = 1;
    optional int64 upper_bound = 2;
    optional int64 value = 3;
}

message SampledTrackerEntry {
    optional int64 allocations = 1;
    optional int64 longest_free_range = 2;
    optional int64 objects = 3;
    optional bool is_hugepage_backed = 4;
    optional bool density = 5;
    optional double reallocation_time_sec = 6;
}

message PrioritizationListOccupancy {
    optional int64 list_index = 1;
    optional int64 value = 2;
}

message FreelistEntry {
    optional int64 sizeclass = 1;
    optional int64 bytes = 2;
    optional int64 num_spans_requested = 3;
    optional int64 num_spans_returned = 4;
    optional int64 obj_capacity = 5;
    repeated HistogramEntry span_util_histogram = 6;
    repeated PrioritizationListOccupancy prioritization_list_occupancy = 7;
    repeated HistogramEntry span_lifetime_histogram = 8;
    repeated HistogramEntry same_span_stats = 9;
}

message TransferCacheEntry {
    optional int64 sizeclass = 1;
    optional int64 insert_hits = 2;
    optional int64 insert_misses = 3;
    optional int64 insert_non_batch_misses = 6;
    optional int64 remove_hits = 4;
    optional int64 remove_misses = 5;
    optional int64 remove_non_batch_misses = 7;
    optional int64 used = 8;
    optional int64 capacity = 9;
    optional int64 max_capacity = 10;
    optional int64 insert_object_misses = 11;
    optional int64 remove_object_hits = 13;
    optional int64 remove_object_misses = 12;
    optional int64 frontend_allocations = 14;
}

message CPUCacheEntry {
    optional int64 cpu = 1;
    optional int64 used = 2;
    optional int64 unused = 3;
    optional bool active = 4;
    optional bool populated = 5;
    optional int64 underflows = 6;
    optional int64 overflows = 7;
    optional int64 reclaims = 8;
    optional int64 size_class_resizes = 9;
}

message SizeClassCapacityEntry {
    optional int64 sizeclass = 5;
    optional int64 min_capacity = 1;
    optional double avg_capacity = 2;
    optional int64 max_capacity = 3;
    optional int64 max_allowed_capacity = 4;
    optional int64 min_last_underflow_ns = 6;
    optional int64 max_last_underflow_ns = 7;
    optional int64 min_last_overflow_ns = 8;
    optional int64 max_last_overflow_ns = 9;
    optional int64 max_capacity_misses = 10;
}

message DynamicSlabEntry {
    optional int64 shift = 1;
    optional int64 grow_count = 2;
    optional int64 shrink_count = 3;
}

message PageHeapEntry {
    optional int64 span_size = 1;
    optional int64 present = 2;
    optional int64 released = 3;
    optional int64 num_spans = 4;
    
    reserved 5, 6, 7, 8;
    
    reserved "avg_live_age_secs", "avg_released_age_secs", "live_age_hist", "released_age_hist";
}

message HugePageUsageStats {
    optional int64 used = 1;
    optional int64 free = 2;
    optional int64 unmapped = 3;
}

message HugePageTracker {
    optional HugePageTrackerType type = 1;
    optional HugePageTrackerObjectType objects = 2;
    repeated HistogramEntry free_pages_histogram = 13;
    repeated HistogramEntry longest_free_range_histogram = 14;
    repeated HistogramEntry allocations_histogram = 15;
    repeated HistogramEntry lifetime_histogram = 17;
    repeated HistogramEntry low_occupancy_lifetime_histogram = 18;
    repeated HistogramEntry long_lived_hugepages_histogram = 19;
    optional int64 total_pages = 20;
    optional int64 num_pages_hugepage_backed = 21;
    repeated HistogramEntry unbacked_histogram = 22;
    repeated HistogramEntry swapped_histogram = 23;
    repeated HistogramEntry used_and_swapped_histogram = 24;
    repeated HistogramEntry used_and_unbacked_histogram = 25;
    repeated SampledTrackerEntry sampled_trackers = 26;
    
    reserved 16;
    
    reserved "allocations_free_pages_histogram";
}

message HugePageFillerSeparateAllocStats {
    optional int64 full_huge_pages = 1;
    optional int64 partial_huge_pages = 2;
    optional int64 released_huge_pages = 3;
    optional int64 partially_released_huge_pages = 4;
}

message HugeRegionDetails {
    optional int64 used_bytes = 1;
    optional int64 free_bytes = 2;
    optional int64 longest_free_range_bytes = 3;
    optional int64 unbacked_bytes = 4;
    optional int64 total_unbacked_bytes = 5;
    optional int64 backed_fully_free_bytes = 6;
}

message HugePageAwareAllocatorSizeStats {
    optional int64 min_span_pages = 1;
    optional int64 max_span_pages = 2;
    optional int64 num_spans_allocated = 3;
    optional int64 num_spans_freed = 4;
    optional int64 live_bytes = 5;
    optional double spans_allocated_per_second = 6;
    optional int64 bytes_allocated_per_second = 7;
}

message MinMaxCurrentStats {
    optional int64 min_bytes = 1;
    optional int64 current_bytes = 2;
    optional int64 max_bytes = 3;
}

message DetailedStat {
    optional int64 epoch = 1;
    optional int64 min_bytes = 2;
    optional int64 max_bytes = 3;
}

message DetailedStatSeries {
    optional int64 window_ms = 1;
    optional int64 epochs = 2;
    repeated DetailedStat measurements = 3;
}

message SubreleaseStatsSeries {
    optional int64 window_ms = 1;
    optional int64 epochs = 2;
    optional int64 min_free_pages_interval_ms = 3;
    optional int64 min_free_pages = 4;
    optional int64 min_free_backed_pages = 5;
    repeated FillerStatsDataPoint measurements = 6;
}

message CollapseErrorStats {
    optional CollapseErrorType type = 1;
    optional int64 count = 2;
}

message HugePageTreatmentStats {
    optional int64 collapse_eligible = 1;
    optional int64 collapse_attempted = 2;
    optional int64 collapse_succeeded = 3;
    repeated CollapseErrorStats collapse_errors = 5;
    optional int64 treated_pages_subreleased = 4;
    optional int64 collapse_total_time_ms = 6;
    optional int64 collapse_max_time_us = 7;
    optional int64 collapse_backoff_delay = 8;
    optional int64 collapse_intervals_skipped = 9;
}

message FillerStatsDataPoint {
    optional int64 epoch = 1;
    optional FillerStats at_minimum_demand = 3;
    optional FillerStats at_maximum_demand = 4;
    optional int64 min_free_pages = 7;
    optional int64 min_free_backed_pages = 8;
    optional int64 num_pages_subreleased = 9;
    optional int64 num_hugepages_broken = 10;
    optional int64 partial_alloc_pages_subreleased = 11;
    
    reserved 2, 5, 6;
    
    reserved "timestamp_ms", "at_minimum_huge_pages", "at_maximum_huge_pages";
}

message FillerStats {
    optional int64 num_pages = 1;
    optional int64 regular_huge_pages = 2;
    optional int64 donated_huge_pages = 3;
    optional int64 partial_released_huge_pages = 4;
    optional int64 released_huge_pages = 5;
    optional int64 used_pages_in_subreleased_huge_pages = 6;
}

message SkippedSubrelease {
    optional int64 skipped_subrelease_short_interval_ms = 9;
    optional int64 skipped_subrelease_long_interval_ms = 10;
    optional int64 skipped_subrelease_pages = 2;
    optional int64 correctly_skipped_subrelease_pages = 3;
    optional int64 pending_skipped_subrelease_pages = 4;
    optional int64 skipped_subrelease_count = 5;
    optional int64 correctly_skipped_subrelease_count = 6;
    optional int64 pending_skipped_subrelease_count = 7;
    optional int64 next_peak_interval_ms = 8;
    
    reserved 1;
    
    reserved "skipped_subrelease_interval_ms";
}

message HugePageAllocatorInfo {
    optional bool using_hpaa = 1;
    optional bool using_hpaa_subrelease = 37;
    optional HugePageUsageStats filler_usage = 2;
    optional HugePageUsageStats region_usage = 3;
    optional HugePageUsageStats cache_usage = 4;
    optional HugePageUsageStats alloc_usage = 5;
    optional HugePageUsageStats lifetime_region_usage = 53;
    optional int64 filler_full_huge_pages = 6;
    optional int64 filler_partial_huge_pages = 7;
    optional int64 filler_released_huge_pages = 8;
    optional int64 filler_partially_released_huge_pages = 45;
    optional int64 filler_quarantined_huge_pages = 9;
    optional int64 filler_free_pages = 10;
    optional int64 filler_unmapped_bytes = 11;
    optional int64 filler_hugepageable_used_bytes = 12;
    optional int64 filler_donated_huge_pages = 41;
    optional int64 filler_abandoned_pages = 54;
    optional int64 filler_used_pages_in_subreleased = 43;
    optional int64 filler_used_pages_in_partial_released = 44;
    optional int64 filler_num_pages_subreleased = 48;
    optional int64 filler_num_hugepages_broken = 49;
    optional int64 filler_num_pages_subreleased_due_to_limit = 50;
    optional int64 filler_num_hugepages_broken_due_to_limit = 51;
    optional HugePageFillerSeparateAllocStats filler_sparsely_accessed_alloc_stats = 55;
    optional HugePageFillerSeparateAllocStats filler_densely_accessed_alloc_stats = 56;
    optional bool use_huge_region_more_often = 57;
    optional int64 filler_previously_released_huge_pages = 58;
    optional int64 filler_previously_released_backed_huge_pages = 72;
    repeated HistogramEntry sparsely_accessed_completed_lifetime_histogram = 78;
    repeated HistogramEntry densely_accessed_completed_lifetime_histogram = 79;
    optional int64 filler_num_free_pages_swapped = 73;
    optional int64 filler_num_used_pages_swapped = 74;
    optional int64 filler_num_used_pages_unbacked = 75;
    optional int64 filler_num_non_free_non_used_unbacked_pages = 76;
    repeated HugePageTracker filler_tracker = 42;
    optional int64 region_num_pages_subreleased = 59;
    optional int64 region_num_pages_subreleased_due_to_limit = 60;
    optional int64 min_huge_region_alloc_size = 16;
    optional int64 huge_region_size = 17;
    repeated HugeRegionDetails huge_region_details = 18;
    optional int64 huge_cache_time_const = 39;
    optional int64 cached_huge_page_bytes = 19;
    optional int64 max_cached_huge_page_bytes = 20;
    optional double huge_cache_hit_rate = 21;
    optional double huge_cache_overflow_rate = 22;
    optional int64 fast_unbacked_bytes = 23;
    optional int64 periodic_unbacked_bytes = 24;
    optional MinMaxCurrentStats huge_cache_usage_stats = 25;
    optional MinMaxCurrentStats huge_cache_offpeak_stats = 26;
    optional MinMaxCurrentStats huge_cache_cache_stats = 27;
    optional DetailedStatSeries huge_cache_history = 38;
    optional int64 num_huge_address_map_treap_nodes_used = 28;
    optional int64 num_huge_address_map_treap_nodes_created = 29;
    optional int64 contiguous_free_bytes = 30;
    optional int64 num_total_requested_huge_pages = 31;
    optional int64 num_in_use_huge_pages = 32;
    optional int64 num_small_allocation_pages = 33;
    optional int64 num_slack_pages = 34;
    optional int64 largest_allocation_pages = 35;
    repeated HugePageAwareAllocatorSizeStats hpaa_stat = 36;
    optional SubreleaseStatsSeries filler_stats_timeseries = 46;
    optional SkippedSubrelease filler_skipped_subrelease = 47;
    optional SubreleaseStatsSeries region_stats_timeseries = 61;
    optional SkippedSubrelease region_skipped_subrelease = 62;
    optional int64 num_released_total_pages = 63;
    optional int64 num_released_release_memory_to_system_pages = 64;
    optional int64 num_released_process_background_actions_pages = 65;
    optional int64 num_released_soft_limit_exceeded_pages = 66;
    optional int64 num_released_hard_limit_exceeded_pages = 67;
    optional HugePageTreatmentStats filler_huge_page_treatment_stats = 77;
    
    reserved 13, 14, 15, 40, 68, 69, 70, 71, 52;
    
    reserved "filler_free_pages_histogram", "filler_longest_free_range_histogram", "filler_allocations_histogram", "huge_cache_regret", "cache_num_hugepages_released", "cache_num_hugepages_released_due_to_limit", "cache_stats_timeseries", "cache_skipped_subrelease", "lifetime_based_allocator_stats";
}

message PageAllocatorEntry {
    optional PageTagType tag = 1;
    repeated PageHeapEntry page_heap = 2;
    optional int64 min_large_span_size = 3;
    optional HugePageAllocatorInfo huge_page_allocator = 4;
}

message GwpAsanStats {
    optional int64 tcmalloc_guarded_sample_parameter = 1;
    optional int64 successful_allocations = 2;
    optional int64 failed_allocations = 16;
    optional int64 skipped_allocations_noslots = 3;
    optional int64 skipped_allocations_filtered = 17;
    optional int64 skipped_allocations_toolarge = 18;
    optional int64 allocated_pages = 4;
    optional int64 quarantine_pages = 5;
    optional int64 high_allocated_pages = 6;
    optional int64 max_allocated_pages = 7;
    optional int64 pages_touched = 11;
    optional int64 total_pages = 12;
    
    reserved 8, 9, 10, 13, 14, 15;
    
    reserved "tcmalloc_uaf_check_parameter", "tcmalloc_uaf_check_quarantine_limit";
}

message SelSanStats {
    optional SelSanStatus status = 1;
}

message SampledProfiles {
    optional int64 current_bytes = 1;
    optional int64 current_fragmentation_bytes = 3;
    optional int64 peak_bytes = 2;
}

message MalloczEntry {
    optional bytes meta = 1;
    optional double scaling_factor = 110 [default = 0.1];
    optional int64 in_use_by_app = 2;
    optional int64 page_heap_freelist = 3;
    optional int64 central_cache_freelist = 4;
    optional int64 per_cpu_cache_freelist = 5;
    optional int64 sharded_transfer_cache_freelist = 60;
    optional int64 transfer_cache_freelist = 6;
    optional int64 thread_cache_freelists = 7;
    optional int64 malloc_metadata = 8;
    optional int64 malloc_metadata_arena_unavailable = 62;
    optional int64 malloc_metadata_arena_unallocated = 63;
    optional int64 actual_mem_used = 9;
    optional int64 unmapped = 10;
    optional int64 virtual_address_space_used = 11;
    optional int64 pagemap_size = 34;
    optional int64 num_spans = 12;
    optional int64 num_spans_created = 28;
    optional int64 num_thread_heaps = 13;
    optional int64 num_thread_heaps_created = 29;
    optional int64 num_stack_traces = 30;
    optional int64 num_stack_traces_created = 31;
    optional int64 num_table_buckets = 32;
    optional int64 num_table_buckets_created = 33;
    optional int64 tcmalloc_page_size = 14;
    optional int64 tcmalloc_huge_page_size = 44;
    optional int64 total_resident = 15;
    optional int64 total_mapped = 16;
    optional int64 pagemap_root_residence = 45;
    optional int64 peak_backed = 70;
    optional int64 peak_application_demand = 71;
    optional int64 percpu_slab_size = 50;
    optional int64 percpu_slab_residence = 51;
    optional VirtualCpuType percpu_vcpu_type = 57;
    optional int64 cpus_allowed = 59;
    optional int64 arena_blocks = 64;
    repeated FreelistEntry freelist = 24;
    repeated TransferCacheEntry transfer_cache = 58;
    optional TransferCacheImplementationType transfer_cache_implementation = 61;
    repeated CPUCacheEntry cpu_cache = 25;
    optional int64 physical_cores_used = 117;
    repeated PageHeapEntry page_heap = 26;
    repeated PageAllocatorEntry page_allocator = 49;
    optional GwpAsanStats gwp_asan = 46;
    optional SelSanStats selsan = 102;
    optional int64 sbrk_sys_allocator = 17;
    optional int64 mmap_sys_allocator = 18;
    optional int64 memory_release_failures = 48;
    optional int64 malloc_release_bytes_per_sec = 19;
    optional int64 tcmalloc_release_rate = 20;
    optional bool tcmalloc_per_cpu_caches = 21;
    optional int64 tcmalloc_max_per_cpu_cache_size = 22;
    optional int64 tcmalloc_max_total_thread_cache_bytes = 23;
    optional int64 tcmalloc_skip_subrelease_short_interval_ns = 82;
    optional int64 tcmalloc_skip_subrelease_long_interval_ns = 83;
    optional int64 tcmalloc_cache_demand_release_short_interval_ns = 114;
    optional int64 tcmalloc_cache_demand_release_long_interval_ns = 115;
    optional int64 profile_sampling_interval = 68;
    optional bool tcmalloc_partial_transfer_cache = 76;
    optional int64 tcmalloc_linear_search_length_tracker_list = 77;
    repeated TransferCacheEntry sharded_transfer_cache = 78;
    optional int64 active_sharded_transfer_caches = 79;
    optional bool tcmalloc_release_partial_alloc_pages = 86;
    optional bool tcmalloc_huge_region_demand_based_release = 99;
    optional bool tcmalloc_release_pages_from_huge_region = 89;
    optional bool tcmalloc_use_wider_slabs = 93;
    optional bool tcmalloc_dense_trackers_sorted_on_spans_allocated = 111;
    repeated SizeClassCapacityEntry size_class_capacity = 67;
    optional int64 dynamic_per_cpu_slab_size = 94;
    repeated DynamicSlabEntry dynamic_slab = 72;
    optional int64 dynamic_slab_madvise_failed_bytes = 73;
    optional int64 min_large_span_size = 27;
    optional HugePageAllocatorInfo huge_page_allocator = 35 [deprecated = true];
    optional int64 container_rss = 36;
    optional int64 container_rss_huge_pages = 37;
    optional int64 container_total_cycles = 38;
    optional int64 container_total_instructions = 39;
    optional int64 new_hooks_present = 40;
    optional int64 delete_hooks_present = 41;
    optional int64 sampled_new_hooks_present = 42;
    optional int64 sampled_delete_hooks_present = 43;
    optional int64 desired_usage_limit_bytes = 52;
    optional int64 hard_usage_limit_bytes = 90;
    optional int64 soft_limit_hits = 54;
    optional int64 hard_limit_hits = 91;
    optional int64 successful_shrinks_after_soft_limit_hit = 85;
    optional int64 successful_shrinks_after_hard_limit_hit = 92;
    optional int64 num_released_total_pages = 103;
    optional int64 num_released_release_memory_to_system_pages = 104;
    optional int64 num_released_process_background_actions_pages = 105;
    optional int64 num_released_soft_limit_exceeded_pages = 106;
    optional int64 num_released_hard_limit_exceeded_pages = 107;
    optional SampledProfiles sampled_profiles = 55;
    optional int64 total_sampled_count = 84;
    optional SizeClassConfiguration size_class_config = 98;
    optional MadvisePreference madvise = 101;
    optional bool tcmalloc_resize_size_class_max_capacity = 108;
    optional int64 text_size_in_bytes = 113;
    optional int64 min_hot_access_hint = 116;
    optional bool usermode_hugepage_collapse = 119;
    optional bool release_free_swapped = 120;
    optional int64 tcmalloc_num_priority_lists = 121;
    
    reserved 56, 65, 69, 75, 80, 81, 109, 87, 66, 74, 88, 95, 96, 118, 100, 112, 47, 53;
    
    reserved "tcmalloc_skip_subrelease_interval_ns", "tcmalloc_shuffle_per_cpu_caches", "tcmalloc_prioritize_spans", "madvise_cold_regions_nohugepage", "tcmalloc_chunks_for_page_tracker_lists", "separate_allocs_for_few_and_many_objects_spans", "tcmalloc_huge_cache_demand_based_release", "tcmalloc_resize_cpu_cache_size_classes", "tcmalloc_reclaim_idle_per_cpu_caches", "tcmalloc_resize_transfer_caches", "tcmalloc_filler_chunks_per_alloc", "tcmalloc_use_all_buckets_for_few_object_spans", "tcmalloc_configure_size_class_max_capacity", "tcmalloc_sparse_trackers_coarse_longest_free_range", "span_max_cache_size", "span_max_cache_array_size", "hard_limit", "limit_hits", "other_info";
}

enum HugePageTrackerType {
    UNKNOWN = 0;
    REGULAR = 1;
    DONATED = 2;
    RELEASED = 3;
    PARTIAL = 4;
}

enum HugePageTrackerObjectType {
    UNKNOWN_OBJECTS = 0;
    SPARSELY_ACCESSED = 1;
    DENSELY_ACCESSED = 2;
}

enum CollapseErrorType {
    ETYPE_OTHER = 0;
    ETYPE_NOMEM = 1;
    ETYPE_BUSY = 2;
    ETYPE_INVAL = 3;
    ETYPE_AGAIN = 4;
}

enum PageTagType {
    NORMAL = 0;
    SAMPLED = 1;
    COLD = 2;
    NORMAL_P1 = 3;
}

enum SelSanStatus {
    SELSAN_NOT_PRESENT = 0;
    SELSAN_DISABLED = 1;
    SELSAN_ENABLED = 2;
}

enum VirtualCpuType {
    NONE = 0;
    FLAT = 1;
    NUMA = 2;
    L3_AWARE = 3;
    SCHED_STATE = 4;
}

enum TransferCacheImplementationType {
    UNKNOWN_TRANSFERCACHE = 0;
    LIFO = 1;
    NO_TRANSFERCACHE = 2;
    RING = 3;
}

enum SizeClassConfiguration {
    SIZE_CLASS_UNKNOWN = 0;
    SIZE_CLASS_POW2_BELOW_64 = 1;
    SIZE_CLASS_POW2_ONLY = 2;
    SIZE_CLASS_LEGACY = 3;
    SIZE_CLASS_LOW_FRAG = 4;
    SIZE_CLASS_FEWER = 5;
    SIZE_CLASS_REUSE = 6;
    SIZE_CLASS_REUSE_V2 = 7;
}

enum MadvisePreference {
    MADVISE_DONTNEED = 0;
    MADVISE_FREE_AND_DONTNEED = 1;
    MADVISE_FREE_ONLY = 2;
    MADVISE_NEVER = 3;
}
